{% extends 'base.html' %}
{% block title %}{{ page_name }}{% endblock %}

{% load i18n %}
{% load league_tags %}
{% block content %}
<div class="text-center">
<h1>{{league.name}}</h1> <h2><a href="{% url 'season' league.season.slug %}">{{league.season.name}}</a></h2>
</div>
<div class='text-center m-3'><a class="page-link" href="#" onclick="openTable(event)"><i class="fas fa-table"></i> Table</a> {% if latest %} | <a class="page-link" href="#" onclick="openFixtures(event)"><i class="fas fa-list"></i> Fixtures</a> {% else %} | <i class="fas fa-list"></i> Fixtures{% endif %}<!-- <a class="page-link" href="{% url 'league_index' %}"><i class="fas fa-chess-board"></i> All Leagues</a>-->
  {% if league.description %}|<a class="page-link" href="#" onclick="openDetails(event)"><i class="fas fa-info-circle"></i> Details</a> {% else %} <i class="fas fa-info-circle"></i> Details {% endif %}</div>


<div class = "col-md-8 ml-auto mr-auto d-none" id="league_fixtures">
<div class="tab d-flex justify-content-center">
  {% if useRounds == False %}
  <button class="tablinks" id="tablink-previous" onclick="previous(event,'date-{{latest|date}}')" > < </button>
  <button id = 'round-current'>{{latest}}</button>
  <button class="tablinks" id = "tablink-next" onclick="next(event,'date-{{latest|date}}')"> > </button>
  {% else %}
  <button class="tablinks" id="tablink-previous" onclick="previous(event,'round-{{latest}}')" > < </button>
  <button id = 'round-current'>Round {{latest}}</button>
  <button class="tablinks" id = "tablink-next" onclick="next(event,'round-{{latest}}')"> > </button>
  {% endif %}
</div>
{% for date,fixtures in games.items %}
{% if useRounds == True %}
<div class = "tabcontent" id = "round-{{date}}">
{% else %}
<div class = "tabcontent" id = "date-{{date|date}}">
{% endif %}


        <table class="table table-striped table-bordered table-hover">
          <thead>
              <tr>
                {% if useRounds == True %}
                <th class="text-center w-20"></th>
                {% endif %}
                <th class="text-center w-35"><i class="fas fa-chess"></i></th>
                <th class="text-center w-10">{% trans "Result" %}</th>
                <th class="text-center w-35"><i class="fas fa-chess"></i></th>
              </tr>
            </thead>
            <tbody>
            {% for match in fixtures %}
            <tr>                
              {% if useRounds == True %}
              <td class="text-center">{{match.date.date}}</td>
              {% endif %}

                <td class="text-center"><a href="{% url 'player' match.white.id %}">{{match.white}}</a></td>
                <td class="text-center"><a href="{% url 'game' match.id %}">{{match.print_result|safe}}</a></td>
                <td class="text-center"><a href="{% url 'player' match.black.id %}">{{match.black}}</a></td>
            </tr>
            {% endfor %}
    
                   </tbody>
            </table>
          </div>
{% endfor %}
        </div>

<div class = "col-md-8 ml-auto mr-auto d-none" id = "league_table">
  {% if standings %}
      {% if league.format == 1 %}
        {% include 'content/swiss_table.html' with standings=standings rounds=league.get_rounds league=league %}
      {% else %}
        {% include 'content/full_table.html' with standings=standings %}
      {% endif %}
  {% endif %} 
</div>

<div class = "col-md-8 ml-auto mr-auto d-none" id = "league_details">
  {% if league.description %}
  {{league.description|safe}}
  {% endif %} 
</div>



Last updated on {{ league.updated_date }}
{% endblock %}

{% block scripts %}
<script>
var roundLinks = [];
var roundTexts  = [];
{% if useRounds == True %}
{% for round,fixtures in games.items %}
roundLinks.push( 'round-{{round}}' );
roundTexts.push( 'Round {{round}}' );
{% endfor %}
var currentRound = 'round-{{latest}}';
{% else %}
{% for date,fixtures in games.items %}
roundLinks.push( 'date-{{date|date}}' );
roundTexts.push( '{{date}}' );
{% endfor %}
var currentRound = 'date-{{latest|date}}';
{% endif %}
function openRound(e, round, roundText) {
  // Declare all variables
  var i, tabcontent, tablinks;
  // Get all elements with class="tabcontent" and hide them
  tabcontent = document.getElementsByClassName("tabcontent");
  for (i = 0; i < tabcontent.length; i++) {
    tabcontent[i].style.display = "none";
  }
  // there needs to be a check in here to make sure
  // the round exists, otherwise there's some 
  // odd behaviour very occasionally later in the same session
  // if a round has been deleted
  document.getElementById(round).style.display = "block";
  currentRound = round;
  document.getElementById('round-current').innerText=roundText;
  //evt.currentTarget.className += " active";
  sessionStorage.setItem('showRound', round);
  sessionStorage.setItem('showRoundText',roundText);

}
function previous(e){
  var i = roundLinks.indexOf(currentRound);
  if (i > 0 ) openRound(e,roundLinks[i-1], roundTexts[i-1]);
}

function next(e){
  var i = roundLinks.indexOf(currentRound);
  if (i != -1 && i < roundLinks.length-1 ) openRound(e,roundLinks[i+1],roundTexts[i+1]);
}

function openTable(e){
  var fixtures = document.getElementById("league_fixtures");
  var table = document.getElementById("league_table");
  var details = document.getElementById("league_details");

  if (table.classList.contains("d-none")) table.classList.remove("d-none");
  if (!fixtures.classList.contains("d-none")) fixtures.classList.add("d-none");
  if (!details.classList.contains("d-none")) details.classList.add("d-none");

  sessionStorage.setItem('showFixtures',false);
  sessionStorage.setItem('showTable',true);
  sessionStorage.setItem('showDetails',false);
}
function openDetails(e){
  var fixtures = document.getElementById("league_fixtures");
  var table = document.getElementById("league_table");
  var details = document.getElementById("league_details");

  if (details.classList.contains("d-none")) details.classList.remove("d-none");
  if (!fixtures.classList.contains("d-none")) fixtures.classList.add("d-none");
  if (!table.classList.contains("d-none")) table.classList.add("d-none");
  sessionStorage.setItem('showFixtures',false);
  sessionStorage.setItem('showTable',false);
  sessionStorage.setItem('showDetails',true);

}

function openFixtures(e){
  var fixtures = document.getElementById("league_fixtures");
  var table = document.getElementById("league_table");
  var details = document.getElementById("league_details");

  if (!table.classList.contains("d-none")) table.classList.add("d-none");
  if (fixtures.classList.contains("d-none")) fixtures.classList.remove("d-none");
  if (!details.classList.contains("d-none")) details.classList.add("d-none");

  sessionStorage.setItem('showFixtures',true);
  sessionStorage.setItem('showTable',false);
  sessionStorage.setItem('showDetails',false);
}

window.onload = function(e){
  var showFixtures = window.sessionStorage.getItem('showFixtures');
  var showRound = window.sessionStorage.getItem('showRound');
  var showDetails = window.sessionStorage.getItem('showDetails');

  var showRoundText = window.sessionStorage.getItem('showRoundText');
  var showLeague = window.sessionStorage.getItem('showLeague');
  if (showFixtures == "true" && showLeague == "{{league}}"){
    openFixtures(e);
  }
  else if (showDetails == "true"){
    openDetails(e);
  }
  else {
    openTable(e);
  }
  if (showRound && showRoundText && showLeague == "{{league}}"){
    openRound(e, showRound, showRoundText);
  }
  else{
  {% if useRounds == True %}
    openRound(e, 'round-{{latest}}', 'Round {{latest}}');
  {% else %} 
    openRound(e, 'date-{{latest|date}}', '{{latest}}')
  {% endif %}
  }
  window.sessionStorage.setItem('showLeague','{{league}}')
}
</script>
{% endblock %}